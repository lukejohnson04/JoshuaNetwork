{% load static %}
{% load templatetags %}
<!DOCTYPE html>
<html>
<head>

	<!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <!-- Bulma CSS -->
    <link rel="stylesheets" type="text/css" href="{% static 'blog/bulma/css/bulma.min.css' %}">

    <link rel="stylesheet" type="text/css" href="{% static 'blog/main.css' %}">
    <script src="{% static 'blog/blog.js' %}"></script>
    <script src="{% static 'blog/jquery.min.js' %}"></script>
    <script src="{% static 'blog/jquery.waypoints.min.js' %}"></script>
    <script src="{% static 'blog/infinite.min.js' %}"></script>
	<!-- <style>
        * {
            font-family: "Comic Sans MS", "Comic Sans", cursive;
        }
      	body {
            background-image: url('/media/default.jpg');
      	}
    </style> -->
	{% if title %}
		<title>Joshua Network - {{ title }}</title>
	{% else %}
		<title>Joshua Network</title>
	{% endif %}
</head>
<body>
	<header class="site-header">
	  <nav class="navbar navbar-expand-md navbar-dark bg-steel fixed-top py-2">
	    <div class="container" style="min-width:98%">
	      <a class="navbar-brand mr-4" href="{% url 'blog-home' %}">Joshua Network</a>
	      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarToggle" aria-controls="navbarToggle" aria-expanded="false" aria-label="Toggle navigation">
	      <span class="navbar-toggler-icon"></span>
	      </button>
	      <div class="collapse navbar-collapse" id="navbarToggle">
	        <div class="navbar-nav mr-auto">
	          <a class="nav-item nav-link" href="{% url 'blog-home' %}">Home</a>
	          <a class="nav-item nav-link" href="{% url 'hall-of-shame' %}">Hall of Shame</a>
	        </div>
	        <!-- Navbar Right Side -->
	        <div class="navbar-nav">
				{% if user.is_authenticated %}
					<a class="nav-item nav-link" href="{% url 'post-create' %}">New Post</a>
					<a class="nav-item nav-link" href="{% url 'user-posts' request.user.username %}">Profile</a>
					<a class="nav-item nav-link" href="{% url 'logout' %}">Logout</a>
					{% show_notifications %}
				{% else %}
					<a class="nav-item nav-link" href="{% url 'login' %}">Login</a>
					<a class="nav-item nav-link" href="{% url 'register' %}">Register</a>
				{% endif %}
	        </div>
	      </div>
	    </div>
	  </nav>
	  {% block header %}{% endblock %}
	</header>
	<main role="main" class="container">
	  <div class="row">
	    <div class="col col-md-7 col-lg-8">
	      {% if messages %}
	        {% for message in messages %}
	          <div class="alert alert-{{ message.tags }}">
	          	{{ message }}
	          </div>
	        {% endfor %}
	      {% endif %}
	      {% block content %}{% endblock %}
	    </div>
	    <!-- taskbar block here -->
	      {% block taskbar %}{% endblock %}
	  </div>
	</main>

	<!-- Optional JavaScript -->
    <!-- Popper.js -->
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script type="text/javascript">
    	function likePost(element, btn) {
    		// Btn 1 == like button
    		// Btn -1 == dislike button
    		var element = $(element);
    		var pk = element.attr("data-pk");
			$.ajax({
				type: 'GET',
				
				url: "{% url 'like-post' %}",
				data: {"post": pk, "btn": btn},
				success: function(response) {
					if (!response["valid"]) {
						alert("Liking the post failed! LOL!");
					} else {
						var el = element.parent();
                        el.find("#likeCount").text(response["post_likes"]);
						var upjoshua = el.find("[class=btn-upjoshua]").find(">:first-child");
						var downjoshua = el.find("[class=btn-downjoshua]").find(">:first-child");
						if (response["karma"] == 1) {
							downjoshua.attr("src", "/media/ui/downjoshua_empty.png");
							upjoshua.attr("src", "/media/ui/upjoshua.png");
						} else {
							upjoshua.attr("src", "/media/ui/upjoshua_empty.png");
							if (response["karma"] == 0) {
								downjoshua.attr("src", "/media/ui/downjoshua_empty.png");
							} else {
								downjoshua.attr("src", "/media/ui/downjoshua.png");
							}
						}
					}
				}
			})
		}

		function postComment(element) {
    		var element = $(element);
    		var post_pk = element.attr("data-pk");
       		var parent_pk = element.attr("parent-comment");
    		var text;
    		if (parent_pk != "") {
    			text = document.getElementById('comment-field-' + parent_pk).value;
    		} else {
    			text = document.getElementById('comment-field').value;
    		}

    		$.ajax({
    			type: 'GET',
    			url: "{% url 'comment-create' %}",
    			data: {"post": post_pk, "content": text, "parent": parent_pk},
    			success: function(response) {
    				if (!response["valid"]) {
    					alert("Failed to post comment");
    				} else {
    					if (response["commented"]) {
    						if (parent_pk == "") {
	    						document.getElementById('comment-field').value = "";
		    					var comment_section = document.getElementById("comment-section");
		    					comment_section.insertAdjacentHTML("afterbegin", response["rendered-comment"]);
	    					} else {
	    						var comment_field = document.getElementById('comment-field-' + parent_pk);
	    						comment_field.value = "";
	    						$(element).parent().hide();
		    					var comment_section = document.getElementById("comment-replies-" + parent_pk);
		    					comment_section.insertAdjacentHTML("afterbegin", response["rendered-comment"]);
	    					}
    						return;
    					}
    				}
    			}
    		})
		}

		function deleteComment(element) {
    		var element = $(element);
    		var pk = element.attr("data-pk");
    		$.ajax({
    			type: 'GET',
    			url: "{% url 'comment-delete' %}",
    			data: {"comment": pk},
    			success: function(response) {
    				if (!response["valid"]) {
    					alert("Failed to delete comment");
    				} else {
    					var deleted_comment = element.parent().parent().parent();
    					deleted_comment.fadeOut();
    				}
    			}
    		})
		}

		function followUser(element, user) {
			console.log("test");
		}

		$(document).on("click", ".reply-btn", function() {
			let reply_box = $(this).parent().next('.reply-box')
			reply_box.toggle()
			$('.reply-box').not(reply_box).hide()
		});

		$(document).on('click', '.follow-btn', function() {
			var element = this;
			var user_pk = $(element).attr("user-pk");
    		$.ajax({
    			type: 'GET',
    			url: "{% url 'follow-user' %}",
    			data: {"user-pk": user_pk},
    			success: function(response) {
    				if (!response["valid"]) {
    					alert("Failed to delete comment");
    				} else {
    					document.getElementById("follower-count-" + user_pk).innerHTML = response["follow-count"] + " Joshowers";
    					if (response["unfollowed"]) {
    						$(element).html("Follow");
    					} else {
    						$(element).html("Unfollow");
    					}
    				}
    			}
    		})
		});

		var infinite = new Waypoint.Infinite({
			element: $('.infinite-container')[0],
			offset: 'bottom-in-view',
			onBeforePageLoad: function() {
				$('.loading').show();
			},

			onAfterPageLoad: function() {
				$('.loading').hide();
			}
		});
	</script>
    </script>
</body>
</html>